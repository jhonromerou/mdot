#!/usr/bin/env bash

# TODO: Buscar format de desacoplar de php artisan

function m-php-set()
{
    if [[ $1 ]]; then
        version="php$1"
    else
        version=`ls -1 /usr/bin | grep -E '^php[0-9]' \
        | fzf --layout=reverse-list --header="Seleccione la versi√≥n a usar" \
        | awk '{ print $1 }' | head -1`;
    fi

    if [[ $version ]]; then
        sudo update-alternatives --set php "/usr/bin/$version"
    fi
}

function m-php-v(){
    php_v=$(php -v | head -1 | awk '{ print $2 }')

    if [ "$1" != "--all" ]; then
        php_v=$(echo "$php_v" | awk -F "." '{ print $1"."$2 }')
    fi
    echo $php_v
}

function m-php-ext-enable()
{
    version_to_use=$1
    if [ "$version_to_use" ]; then
        php_v="$version_to_use"
    else
        php_v=$(m-php-v)
    fi

    path="/etc/php/$php_v/mods-available"
    
    cd $path
    ext_sel=$(grep -r $path -e '^[;].*extension' \
     | awk -F ":" '{ print $1 }' \
     | fzf --preview='head {}'
    )

    if [[ $ext_sel ]]; then
        line_num=$(grep -ne '^[;].*extension' $ext_sel | awk -F ":" '{ print $1 }')
        sudo sed -i '3s/;//' $ext_sel
        echo "Extension enabled"
        echo $ext_sel
    fi

    cd $MDOT_PWD
}

function m-php-ext-disable()
{
    version_to_use=$1
    if [ "$version_to_use" ]; then
        php_v="$version_to_use"
    else
        php_v=$(m-php-v)
    fi

    path="/etc/php/$php_v/mods-available"

    cd $path
    ext_sel=$(grep -rsv . -e '^;.*extension' \
        | awk -F ":" '{ print $1 }' \
        | awk -F "./" '{ print $2 }' \
        | fzf --preview='head {}'
    )

    if [[ $ext_sel ]]; then
        line=$(grep -n ".*extension" $ext_sel)
        line_num=$(echo "$line" | awk -F ":" '{ print $1 }')
        line_txt=$(echo "$line" | awk -F ":" '{ print $2 }')
        sudo sed -i "${line_num}s/${line_txt}/;${line_txt}/" $path/$ext_sel
        echo "Extension disabled"
        echo $path/$ext_sel
    fi

    cd $MDOT_PWD
}